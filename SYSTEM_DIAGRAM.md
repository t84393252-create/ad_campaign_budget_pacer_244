# üèóÔ∏è Ad Campaign Budget Pacer - Complete System Diagram

## üìä Full System Flow

```mermaid
graph TB
    subgraph "üåê External Systems"
        RTB[Real-Time Bidding Platform<br/>100ms auction window]
        ADV[Advertisers<br/>Campaign Setup]
    end

    subgraph "üéØ User Interface Layer"
        DASH[Dashboard<br/>HTML/JS/Chart.js]
        API_CLIENT[API Clients<br/>curl/SDK]
    end

    subgraph "üîÑ Load Balancer"
        NGINX[Nginx Reverse Proxy<br/>Port 80<br/>- Routes /api ‚Üí FastAPI<br/>- Routes / ‚Üí Dashboard<br/>- Routes /pacing ‚Üí Go Service]
    end

    subgraph "üêç Management Layer"
        FASTAPI[FastAPI Service<br/>Port 8000<br/>- Campaign CRUD<br/>- Budget Management<br/>- Historical Analytics]
    end

    subgraph "‚ö° Core Pacing Engine"
        PACER[Go Pacer Service<br/>Port 8080<br/>- Sub-10ms decisions<br/>- Circuit Breakers<br/>- Pacing Algorithms]
        
        subgraph "Algorithms"
            EVEN[EVEN Pacing]
            ASAP[ASAP Pacing]
            FRONT[FRONT_LOADED]
            ADAPT[ADAPTIVE]
        end
        
        CB[Circuit Breaker<br/>- CLOSED: Normal<br/>- OPEN: @ 95% spent<br/>- HALF_OPEN: Recovery]
    end

    subgraph "üíæ Data Layer"
        REDIS[(Redis<br/>Port 6379<br/>Real-time Counters<br/>TTL: 24 hours)]
        PG[(PostgreSQL<br/>Port 5432<br/>Campaigns<br/>Historical Data)]
        MEMORY[In-Memory Cache<br/>Fallback during<br/>Redis failure]
    end

    %% User flows
    ADV -->|Create Campaign| DASH
    DASH -->|HTTP| NGINX
    API_CLIENT -->|HTTP| NGINX
    
    %% Nginx routing
    NGINX -->|/api/*| FASTAPI
    NGINX -->|Static Files| DASH
    NGINX -->|/pacing/*<br/>/spend/*<br/>/budget/*| PACER
    
    %% FastAPI operations
    FASTAPI -->|Campaign Config| PG
    FASTAPI -->|Budget Status| PACER
    
    %% RTB flow
    RTB -->|Bid Request<br/>campaign_id<br/>bid_cents| PACER
    PACER -->|Allow/Deny<br/>< 10ms| RTB
    
    %% Pacer internal flow
    PACER --> CB
    CB --> EVEN
    CB --> ASAP
    CB --> FRONT
    CB --> ADAPT
    
    %% Data flows
    PACER -->|Increment Spend| REDIS
    PACER -->|Read Counters| REDIS
    PACER -->|Fallback| MEMORY
    MEMORY -->|Sync on Recovery| REDIS
    PACER -->|Load Campaigns| PG
    PACER -->|Store History| PG

    style RTB fill:#ff9999,color:#000
    style PACER fill:#99ff99,color:#000
    style CB fill:#ffcc99,color:#000
    style REDIS fill:#99ccff,color:#000
    style PG fill:#cc99ff,color:#000
    style NGINX fill:#f9f9f9,color:#000
    style FASTAPI fill:#f0f0f0,color:#000
    style DASH fill:#f5f5f5,color:#000
    style MEMORY fill:#ffffcc,color:#000
```

## üîÑ Request Flow Sequences

### 1Ô∏è‚É£ Bid Decision Flow (< 10ms)

```
RTB Platform                  Pacer Service              Redis              Circuit Breaker
     |                             |                       |                      |
     |------ Bid Request --------->|                       |                      |
     |   {campaign_id, bid_cents}  |                       |                      |
     |                             |                       |                      |
     |                             |---Get Spent Today---->|                      |
     |                             |<------$4,500----------|                      |
     |                             |                       |                      |
     |                             |---Check Threshold---->|                      |
     |                             |                       |---Is 45% < 95%?----->|
     |                             |                       |<-----CLOSED----------|
     |                             |                       |                      |
     |                             |--Calculate Throttle-->|                      |
     |                             |  (EVEN: 0% throttle)  |                      |
     |                             |                       |                      |
     |<------ALLOW BID-------------|                       |                      |
     |      (< 10ms total)         |                       |                      |
```

### 2Ô∏è‚É£ Spend Tracking Flow

```
Winner Notification           Pacer Service              Redis              PostgreSQL
     |                             |                       |                      |
     |------Spend Update---------->|                       |                      |
     |  {campaign_id, spend_cents} |                       |                      |
     |                             |                       |                      |
     |                             |---INCR daily:camp-001->|                      |
     |                             |---INCR hourly:camp-001>|                      |
     |                             |                       |                      |
     |                             |----Store for History------------------------>|
     |                             |                       |                      |
     |<---------ACK----------------|                       |                      |
```

### 3Ô∏è‚É£ Circuit Breaker Trip Flow (at 95% threshold)

```
High Spending Period         Pacer Service          Circuit Breaker         Redis
     |                             |                      |                   |
     |------Bid Request----------->|                      |                   |
     |                             |--Get Spent---------->|                   |
     |                             |<----$9,501-----------|                   |
     |                             |                      |                   |
     |                             |--Check: 95.01% > 95%->|                   |
     |                             |<-------TRIP!---------|                   |
     |                             |   State ‚Üí OPEN       |                   |
     |                             |                      |                   |
     |<------DENY BID--------------|                      |                   |
     |   "Circuit breaker open"    |                      |                   |
     |                             |                      |                   |
     === 30 seconds later ===      |                      |                   |
     |                             |--Timer Expired------>|                   |
     |                             |<--State ‚Üí HALF_OPEN--|                   |
     |                             |                      |                   |
     |------Test Request---------->|                      |                   |
     |                             |--Allow 1 test bid--->|                   |
     |<------ALLOW (throttled)-----|                      |                   |
     |                             |                      |                   |
     |------Another Request------->|                      |                   |
     |                             |--Success count = 2--->|                   |
     |                             |<--State ‚Üí CLOSED-----|                   |
     |<------ALLOW (90% throttle)--|                      |                   |
```

### 4Ô∏è‚É£ Redis Failover Flow

```
Normal Operation            Redis Fails              Degraded Mode           Redis Recovers
     |                          |                         |                        |
     |---Bid Request-->        |                         |                        |
     |<--Use Redis Data--       |                         |                        |
     |                          |                         |                        |
     |                     [Redis Down]                   |                        |
     |                          |                         |                        |
     |                          |---Bid Request---------->|                        |
     |                          |--Redis Timeout (100ms)->|                        |
     |                          |<--Switch to Memory------|                        |
     |                          |<--Conservative Decision-|                        |
     |                          |   (50% throttle)        |                        |
     |                          |                         |                        |
     |                          |---Track in Memory------>|                        |
     |                          |   {camp-001: $500}      |                        |
     |                          |                         |                        |
     |                          |                    [Redis Back Up]               |
     |                          |                         |----Health Check OK---->|
     |                          |                         |<---Sync Memory Data--->|
     |                          |                         |    MSET operations     |
     |                          |                         |<---Normal Mode-------->|
```

## üéØ Component Responsibilities

### Pacer Service (Go) - Core Engine
```
Responsibilities:
‚îú‚îÄ‚îÄ Make bid decisions in < 10ms
‚îú‚îÄ‚îÄ Track spending in real-time
‚îú‚îÄ‚îÄ Enforce budget limits via circuit breaker
‚îú‚îÄ‚îÄ Implement 4 pacing algorithms
‚îú‚îÄ‚îÄ Handle 10,000+ QPS
‚îî‚îÄ‚îÄ Gracefully degrade during failures

Key Files:
‚îú‚îÄ‚îÄ /pacer-service/pacer/algorithm.go     - Pacing algorithms
‚îú‚îÄ‚îÄ /pacer-service/pacer/circuitbreaker.go - Circuit breaker logic
‚îú‚îÄ‚îÄ /pacer-service/pacer/tracker.go        - Spend tracking
‚îî‚îÄ‚îÄ /pacer-service/pacer/service.go        - HTTP handlers
```

### FastAPI (Python) - Management Layer
```
Responsibilities:
‚îú‚îÄ‚îÄ Campaign CRUD operations
‚îú‚îÄ‚îÄ Budget configuration
‚îú‚îÄ‚îÄ Historical analytics
‚îú‚îÄ‚îÄ Dashboard data API
‚îî‚îÄ‚îÄ Administrative functions

Endpoints:
‚îú‚îÄ‚îÄ GET    /campaigns              - List all campaigns
‚îú‚îÄ‚îÄ POST   /campaigns              - Create campaign
‚îú‚îÄ‚îÄ PUT    /campaigns/{id}         - Update campaign
‚îú‚îÄ‚îÄ DELETE /campaigns/{id}         - Delete campaign
‚îî‚îÄ‚îÄ GET    /budget/status/{id}     - Get budget status
‚îî‚îÄ‚îÄ GET    /analytics/performance  - Performance metrics
```

### Redis - Real-time State
```
Data Structure:
‚îú‚îÄ‚îÄ budget:day:camp-001:2024-01-15    ‚Üí 450000 (cents spent today)
‚îú‚îÄ‚îÄ budget:hour:camp-001:2024-01-15-14 ‚Üí 25000 (cents this hour)
‚îú‚îÄ‚îÄ throttle:camp-001                  ‚Üí 0.25 (current throttle rate)
‚îî‚îÄ‚îÄ cb:state:camp-001                  ‚Üí "OPEN" (circuit breaker state)

TTL Strategy:
‚îú‚îÄ‚îÄ Daily keys:  24 hours
‚îú‚îÄ‚îÄ Hourly keys: 2 hours
‚îî‚îÄ‚îÄ State keys:  1 hour
```

### PostgreSQL - Persistent Storage
```
Tables:
‚îú‚îÄ‚îÄ campaigns
‚îÇ   ‚îú‚îÄ‚îÄ id (UUID)
‚îÇ   ‚îú‚îÄ‚îÄ name
‚îÇ   ‚îú‚îÄ‚îÄ daily_budget_cents
‚îÇ   ‚îú‚îÄ‚îÄ total_budget_cents
‚îÇ   ‚îú‚îÄ‚îÄ pacing_algorithm
‚îÇ   ‚îú‚îÄ‚îÄ start_date
‚îÇ   ‚îî‚îÄ‚îÄ end_date
‚îÇ
‚îú‚îÄ‚îÄ spend_history
‚îÇ   ‚îú‚îÄ‚îÄ campaign_id
‚îÇ   ‚îú‚îÄ‚îÄ timestamp
‚îÇ   ‚îú‚îÄ‚îÄ spend_cents
‚îÇ   ‚îî‚îÄ‚îÄ impressions
‚îÇ
‚îî‚îÄ‚îÄ performance_metrics
    ‚îú‚îÄ‚îÄ campaign_id
    ‚îú‚îÄ‚îÄ date
    ‚îú‚îÄ‚îÄ total_spent_cents
    ‚îú‚îÄ‚îÄ impressions
    ‚îú‚îÄ‚îÄ avg_latency_ms
    ‚îî‚îÄ‚îÄ throttle_rate
```

## üìà Performance Characteristics

### Latency Breakdown (P99 < 10ms requirement)
```
Operation                Time Budget
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Redis GET                    1ms
Circuit Breaker Check        0.1ms
Algorithm Calculation        0.5ms
JSON Parse/Response          0.5ms
Network RTT                  2ms
Buffer/Overhead             5.9ms
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
TOTAL P99                   <10ms ‚úì
```

### Throughput Capacity
```
Component            Capacity    Bottleneck
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Pacer Service        50,000 QPS  CPU
Redis               100,000 QPS  Network I/O
PostgreSQL           5,000 QPS   Disk I/O
Nginx               75,000 QPS   CPU
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
System Max          ~50,000 QPS  (Pacer CPU)
```

## üîí Failure Scenarios & Recovery

### Scenario 1: Redis Failure
```
Detection: Health check timeout (100ms)
Action:    Switch to in-memory cache
Impact:    Conservative pacing (50% throttle)
Recovery:  Auto-sync when Redis returns
Data Loss: None (memory preserved)
```

### Scenario 2: Circuit Breaker Trip
```
Trigger:   95% of daily budget spent
Action:    DENY all bids for 30 seconds
Recovery:  HALF_OPEN ‚Üí test 2 bids ‚Üí CLOSED
Impact:    Temporary bid blocking
Purpose:   Prevent budget overrun
```

### Scenario 3: PostgreSQL Failure
```
Detection: Connection timeout
Impact:    Cannot load new campaigns
Fallback:  Use cached campaign data
Recovery:  Reconnect and reload
Critical:  Existing campaigns continue
```

### Scenario 4: High Load Spike
```
Detection: Latency > 10ms
Action:    Increase throttle rate
Method:    Adaptive algorithm adjusts
Recovery:  Reduce throttle as load drops
Protection: Circuit breaker as last resort
```

## üöÄ Scaling Strategy

### Horizontal Scaling
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Pacer #1   ‚îÇ     ‚îÇ  Pacer #2   ‚îÇ     ‚îÇ  Pacer #3   ‚îÇ
‚îÇ  Port 8080  ‚îÇ     ‚îÇ  Port 8081  ‚îÇ     ‚îÇ  Port 8082  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                   ‚îÇ                   ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ   Shared Redis  ‚îÇ
              ‚îÇ   Cluster       ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Sharding Strategy
```
Campaign ID Hash ‚Üí Shard Selection
‚îú‚îÄ‚îÄ Shard 1: Campaigns 0-33%
‚îú‚îÄ‚îÄ Shard 2: Campaigns 34-66%
‚îî‚îÄ‚îÄ Shard 3: Campaigns 67-100%
```

This comprehensive diagram shows how all components interact to deliver sub-10ms bid decisions while preventing budget overspending through circuit breakers and intelligent pacing algorithms.